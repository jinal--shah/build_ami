#!/bin/bash
# vim: et sr sw=4 ts=4 smartindent syntax=sh:
#
# get_instance_info
#
# Gets IMMUTABLE instance info from AWS metadata and writes out
# as key=val pairs for consumption by scripts or docker --env_file
#
# i.e. we're not interested in those metadata or tag values
# that are subject to change during the lifestyle of the instance.
#
INFO_FILE=/etc/eurostar/instance_info
TIMESTAMP="$(date +'%Y-%m-%d %H:%M:%S')"

AWS_DOC_URI=http://169.254.169.254/latest/dynamic/instance-identity/document
AWS_DOC=$(curl -s $AWS_DOC_URI)
if [[ -z $AWS_DOC ]]; then
    echo "$0 ERROR: couldn't fetch $AWS_DOC_URI with curl"
    exit 1
fi

AWS_INSTANCE_ID=$(echo "$AWS_DOC" | grep '^[ ]\+"instanceId"'   | awk -F\" '{print $4}')
AWS_DEFAULT_REGION=$(echo "$AWS_DOC" | grep '^[ ]\+"region"'       | awk -F\" '{print $4}')

cat << EOF >$INFO_FILE
# [$TIMESTAMP] AWS INSTANCE INFO GENERATED BY $0
AWS_ACCOUNT_ID=$(                                                            \
    curl -s http://169.254.169.254/latest/dynamic/instance-identity/document \
    | jq -r '. | .accountId'                                                 \
)
AWS_INSTANCE_ID=$AWS_INSTANCE_ID
AWS_INSTANCE_TYPE=$(echo "$AWS_DOC" | grep '^[ ]\+"instanceType"' | awk -F\" '{print $4}')
AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION
AWS_AZ=$( echo "$AWS_DOC" | grep '^[ ]\+"availabilityZone"' | awk -F\" '{print $4}' |
    sed -e 's/.*\(.\)$/\1/'
)
# ... AWS TAG VALUES (tag name, uppercased)
$(                                                            \
    aws --region $AWS_DEFAULT_REGION ec2 describe-tags        \
        --filters "Name=resource-type,Values=instance"        \
                  "Name=resource-id,Values=$AWS_INSTANCE_ID"  \
        --query "Tags[*].{Value:Value,Key:Key}" --output=text \
    | sed -e 's/^\(Name=\)/AWS_\1/'                           \
    | sed -e 's/^\([^ \t]\+\)[ \t]\+\([^ \t]\+\)/\U\1\E=\2/'  \
)
AWS_ECR_ACCOUNT=${AWS_ECR_ACCOUNT:-018274991670}
# END AWS INSTANCE INFO GENERATED BY $0
EOF

cat $INFO_FILE

